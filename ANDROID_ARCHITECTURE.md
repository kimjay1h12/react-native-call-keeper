# Android Architecture Guide - expo-call-keep

> Complete guide to the Android implementation of expo-call-keep with New Architecture support

## üì¶ Package Information

- **Package Name:** `expo-call-keep`
- **Current Version:** 1.0.3
- **Language:** Kotlin (converted from Java)
- **Architecture Support:** Both Old and New Architecture (TurboModules)
- **Minimum SDK:** Android 6.0+ (API 23+)
- **Target SDK:** Android 13+ (API 33+)

---

## üèóÔ∏è Project Structure

```
android/
‚îú‚îÄ‚îÄ build.gradle                    # Main build configuration
‚îú‚îÄ‚îÄ gradle.properties              # Gradle properties
‚îî‚îÄ‚îÄ src/
    ‚îú‚îÄ‚îÄ main/
    ‚îÇ   ‚îî‚îÄ‚îÄ kotlin/com/callkeeper/
    ‚îÇ       ‚îú‚îÄ‚îÄ CallKeeperPackage.kt      # ReactPackage registration
    ‚îÇ       ‚îî‚îÄ‚îÄ VoiceConnectionService.kt # Android ConnectionService
    ‚îÇ
    ‚îú‚îÄ‚îÄ oldarch/                          # Old Architecture (Legacy)
    ‚îÇ   ‚îú‚îÄ‚îÄ java/com/callkeeper/
    ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ CallKeeperSpec.java      # Old arch spec (Java)
    ‚îÇ   ‚îî‚îÄ‚îÄ kotlin/com/callkeeper/
    ‚îÇ       ‚îú‚îÄ‚îÄ CallKeeperModule.kt       # Old arch implementation
    ‚îÇ       ‚îî‚îÄ‚îÄ CallKeeperSpec.kt        # Old arch spec (Kotlin)
    ‚îÇ
    ‚îî‚îÄ‚îÄ newarch/                          # New Architecture (TurboModules)
        ‚îî‚îÄ‚îÄ kotlin/com/callkeeper/
            ‚îú‚îÄ‚îÄ CallKeeperModule.kt       # New arch implementation
            ‚îî‚îÄ‚îÄ CallKeeperSpec.kt        # New arch spec (extends NativeCallKeeperSpec)
```

---

## üîß Build Configuration

### build.gradle

The build system automatically selects the correct source sets based on the `newArchEnabled` property:

```gradle
def isNewArchitectureEnabled() {
  return rootProject.hasProperty("newArchEnabled") &&
         rootProject.getProperty("newArchEnabled") == "true"
}

sourceSets {
  main {
    kotlin.srcDirs += ["src/main/kotlin"]
    if (isNewArchitectureEnabled()) {
      kotlin.srcDirs += ["src/newarch/kotlin"]
      java.srcDirs += [
        "src/newarch/java",
        "${project.buildDir}/generated/source/codegen/java"
      ]
    } else {
      kotlin.srcDirs += ["src/oldarch/kotlin"]
      java.srcDirs += ["src/oldarch/java"]
    }
  }
}
```

### Enabling New Architecture

Add to your app's `android/gradle.properties`:

```properties
newArchEnabled=true
```

---

## üìÅ File Descriptions

### Main Files (Shared)

#### `CallKeeperPackage.kt`

- **Location:** `src/main/kotlin/com/callkeeper/`
- **Purpose:** React Native package registration
- **Architecture:** Works with both old and new architecture
- **Key Features:**
  - Automatically detects architecture
  - Creates module for old architecture
  - Returns empty list for new architecture (auto-registered by codegen)

```kotlin
class CallKeeperPackage : ReactPackage {
    override fun createNativeModules(reactContext: ReactApplicationContext): List<NativeModule> {
        return try {
            listOf(CallKeeperModule(reactContext))
        } catch (e: Exception) {
            emptyList() // New Architecture - auto-registered
        }
    }
}
```

#### `VoiceConnectionService.kt`

- **Location:** `src/main/kotlin/com/callkeeper/`
- **Purpose:** Android ConnectionService for VoIP calls
- **Architecture:** Shared between both architectures
- **Key Features:**
  - Manages active connections
  - Handles call state transitions
  - Emits events to JavaScript
  - Supports hold, mute, DTMF

---

### Old Architecture Files

#### `CallKeeperModule.kt` (Old Arch)

- **Location:** `src/oldarch/kotlin/com/callkeeper/`
- **Extends:** `CallKeeperSpec` (old arch)
- **Purpose:** Main module implementation for legacy React Native
- **Key Methods:**
  - `setup()` - Initialize CallKeeper
  - `displayIncomingCall()` - Show incoming call UI
  - `startCall()` - Start outgoing call
  - `endCall()` - End call
  - All 17 methods from the TypeScript spec

#### `CallKeeperSpec.kt` (Old Arch)

- **Location:** `src/oldarch/kotlin/com/callkeeper/`
- **Extends:** `ReactContextBaseJavaModule`
- **Purpose:** Abstract spec defining method signatures

---

### New Architecture Files

#### `CallKeeperModule.kt` (New Arch)

- **Location:** `src/newarch/kotlin/com/callkeeper/`
- **Extends:** `CallKeeperSpec` (new arch) ‚Üí `NativeCallKeeperSpec` (codegen)
- **Purpose:** TurboModule implementation
- **Key Features:**
  - Auto-generated spec from TypeScript
  - Promise-based methods
  - Event emission support
  - Same API as old architecture

#### `CallKeeperSpec.kt` (New Arch)

- **Location:** `src/newarch/kotlin/com/callkeeper/`
- **Extends:** `NativeCallKeeperSpec` (generated by codegen)
- **Purpose:** Base class for TurboModule implementation

---

## üîÑ Architecture Comparison

| Feature                 | Old Architecture             | New Architecture                      |
| ----------------------- | ---------------------------- | ------------------------------------- |
| **Base Class**          | `ReactContextBaseJavaModule` | `NativeCallKeeperSpec` (codegen)      |
| **Spec Location**       | Manual Kotlin/Java file      | Auto-generated from TypeScript        |
| **Module Registration** | Via `ReactPackage`           | Auto-registered by TurboModule system |
| **Method Signatures**   | Manual implementation        | Generated from `NativeCallKeeper.ts`  |
| **Event Emission**      | `DeviceEventManagerModule`   | `DeviceEventManagerModule`            |
| **Promise Support**     | Manual `@ReactMethod`        | Auto-generated from TypeScript        |

---

## üöÄ Implementation Details

### Module Initialization

Both architectures follow the same initialization pattern:

```kotlin
override fun setup(options: ReadableMap, promise: Promise) {
    try {
        settings = options
        val appName = options.getString("appName") ?: "App"

        // Set ReactContext for event sending
        VoiceConnectionService.setReactContext(reactApplicationContext)

        // Register PhoneAccount
        val telecomManager = context.getSystemService(Context.TELECOM_SERVICE) as TelecomManager
        val componentName = android.content.ComponentName(context, VoiceConnectionService::class.java)
        phoneAccountHandle = PhoneAccountHandle(componentName, appName)

        val phoneAccount = PhoneAccount.builder(phoneAccountHandle!!, appName)
            .setCapabilities(PhoneAccount.CAPABILITY_SELF_MANAGED)
            .setShortDescription(appName)
            .build()

        telecomManager.registerPhoneAccount(phoneAccount)
        promise.resolve(null)
    } catch (e: Exception) {
        promise.reject("SETUP_ERROR", "Failed to setup CallKeeper: ${e.message}", e)
    }
}
```

### Event Emission

Events are sent through the ReactContext:

```kotlin
private fun sendEvent(eventName: String, params: WritableMap?) {
    reactApplicationContext
        .getJSModule(DeviceEventManagerModule.RCTDeviceEventEmitter::class.java)
        .emit(eventName, params)
}
```

### ConnectionService Integration

The `VoiceConnectionService` manages call connections:

```kotlin
class VoiceConnectionService : ConnectionService() {
    companion object {
        private val activeConnections = ConcurrentHashMap<String, VoiceConnection>()
        private var reactContext: ReactApplicationContext? = null

        fun setReactContext(context: ReactApplicationContext?) {
            reactContext = context
        }

        private fun sendEvent(eventName: String, params: WritableMap?) {
            reactContext?.let { context ->
                context.getJSModule(DeviceEventManagerModule.RCTDeviceEventEmitter::class.java)
                    .emit(eventName, params)
            }
        }
    }
}
```

---

## üêõ Common Issues & Fixes

### Issue 1: Redeclaration Error

**Error:** `Redeclaration: class CallKeeperModule`

**Cause:** Both old and new arch modules were in the same source set.

**Fix:** Moved old arch module to `src/oldarch/kotlin/` and new arch to `src/newarch/kotlin/`.

### Issue 2: Missing Bundle Import

**Error:** `Unresolved reference 'Bundle'`

**Fix:** Added `import android.os.Bundle` to `CallKeeperModule.kt`.

### Issue 3: Connection API Errors

**Error:** `Unresolved reference 'setAudioRouteIsMuted'`

**Fix:** Changed to `setMuted()` method:

```kotlin
// Before
activeConnections[callUUID]?.setAudioRouteIsMuted(muted)

// After
activeConnections[callUUID]?.setMuted(muted)
```

### Issue 4: StatusHints Builder Error

**Error:** `Unresolved reference 'Builder'`

**Fix:** Use constructor instead:

```kotlin
// Before
val statusHints = StatusHints.Builder().setLabel(displayName).build()

// After
val statusHints = StatusHints(displayName, null, null)
```

### Issue 5: setActive Override Error

**Error:** `'setActive' in 'Connection' is final and cannot be overridden`

**Fix:** Created helper method instead:

```kotlin
// Before
override fun setActive() {
    super.setActive()
    sendEvent("didActivateAudioSession", null)
}

// After
fun activate() {
    setActive()
    sendEvent("didActivateAudioSession", null)
}
```

---

## ‚úÖ Testing

### Build Test

```bash
cd android
./gradlew clean build
```

### Test in App

1. **Install package:**

   ```bash
   npm install expo-call-keep@1.0.3 --legacy-peer-deps
   ```

2. **Enable New Architecture (optional):**

   ```properties
   # android/gradle.properties
   newArchEnabled=true
   ```

3. **Rebuild:**
   ```bash
   cd android && ./gradlew clean && cd ..
   npx react-native run-android
   ```

### Verify Module Registration

Check logs for:

- Old Architecture: `CallKeeperModule initialized`
- New Architecture: `TurboModuleRegistry: CallKeeper found`

---

## üìù Code Generation (New Architecture)

The New Architecture uses codegen to generate native specs from TypeScript:

1. **Source:** `src/NativeCallKeeper.ts`
2. **Codegen Config:** `package.json` ‚Üí `codegenConfig`
3. **Output:** `android/build/generated/source/codegen/java/com/callkeeper/NativeCallKeeperSpec.java`

### Codegen Configuration

```json
{
  "codegenConfig": {
    "name": "CallKeeperSpec",
    "type": "modules",
    "jsSrcsDir": "src",
    "android": {
      "javaPackageName": "com.callkeeper"
    }
  }
}
```

---

## üîê Permissions

Required permissions (handled by Expo config plugin):

```xml
<uses-permission android:name="android.permission.BIND_TELECOM_CONNECTION_SERVICE"/>
<uses-permission android:name="android.permission.FOREGROUND_SERVICE"/>
<uses-permission android:name="android.permission.READ_PHONE_STATE"/>
<uses-permission android:name="android.permission.CALL_PHONE"/>
<uses-permission android:name="android.permission.RECORD_AUDIO"/>
<uses-permission android:name="android.permission.WAKE_LOCK"/>
<uses-permission android:name="android.permission.READ_CALL_LOG"/>
<uses-permission android:name="android.permission.WRITE_CALL_LOG"/>
<uses-permission android:name="android.permission.MANAGE_OWN_CALLS"/>
```

---

## üìö API Reference

All methods are available in both architectures:

### Setup

- `setup(options: CallKeeperOptions): Promise<void>`

### Call Management

- `displayIncomingCall(callUUID, handle, name?, type?, hasVideo?): Promise<void>`
- `startCall(callUUID, handle, contactId?, type?, hasVideo?): Promise<void>`
- `endCall(callUUID: string): Promise<void>`
- `endAllCalls(): Promise<void>`
- `answerIncomingCall(callUUID: string): Promise<void>`
- `rejectCall(callUUID: string): Promise<void>`

### Call Controls

- `setMutedCall(callUUID: string, muted: boolean): Promise<void>`
- `setOnHold(callUUID: string, onHold: boolean): Promise<void>`
- `updateDisplay(callUUID, displayName, handle): Promise<void>`

### Status & Utilities

- `checkPermissions(): Promise<boolean>`
- `checkIsInManagedCall(): Promise<boolean>`
- `setAvailable(available: boolean): Promise<void>`
- `setCurrentCallActive(callUUID: string): Promise<void>`
- `backToForeground(): Promise<void>`

### Reporting

- `reportConnectedOutgoingCall(callUUID: string): Promise<void>`
- `reportEndCallWithUUID(callUUID: string, reason: number): Promise<void>`

---

## üéØ Migration from Java

The package was converted from Java to Kotlin for:

- ‚úÖ Better null safety
- ‚úÖ Modern language features
- ‚úÖ Improved maintainability
- ‚úÖ Better IDE support

### Key Conversions

| Java                         | Kotlin                                                 |
| ---------------------------- | ------------------------------------------------------ |
| `ReactContextBaseJavaModule` | `ReactContextBaseJavaModule` (same)                    |
| `@ReactMethod`               | `override fun` (New Arch) or `@ReactMethod` (Old Arch) |
| `Promise`                    | `Promise` (same)                                       |
| `ReadableMap`                | `ReadableMap` (same)                                   |
| `WritableMap`                | `WritableMap` (same)                                   |

---

## üîó Related Files

- **TypeScript Spec:** `src/NativeCallKeeper.ts`
- **Main Export:** `src/index.tsx`
- **iOS Implementation:** `ios/RNCallKeep/RNCallKeep.swift`
- **Expo Plugin:** `app.plugin.js`
- **Package Config:** `package.json`

---

## üìñ Additional Resources

- [React Native New Architecture](https://reactnative.dev/docs/the-new-architecture/landing-page)
- [Android ConnectionService](https://developer.android.com/reference/android/telecom/ConnectionService)
- [TurboModules Guide](https://reactnative.dev/docs/the-new-architecture/pillars-turbomodules)
- [Expo Config Plugins](https://docs.expo.dev/config-plugins/introduction/)

---

## üêõ Troubleshooting

### Module Not Found

```bash
# Clean and rebuild
cd android && ./gradlew clean && cd ..
npx react-native run-android
```

### Compilation Errors

1. Check `newArchEnabled` property matches your setup
2. Verify all imports are correct
3. Ensure Kotlin version matches (1.9.0)

### Events Not Firing

1. Ensure `setup()` is called first
2. Check `VoiceConnectionService.setReactContext()` is called
3. Verify event listeners are registered in JavaScript

---

**Last Updated:** Version 1.0.3  
**Maintained By:** expo-call-keep contributors
